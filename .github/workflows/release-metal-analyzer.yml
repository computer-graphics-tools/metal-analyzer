name: Release metal-analyzer

on:
  release:
    types:
      - published

permissions:
  contents: write
  id-token: write

jobs:
  build-binaries:
    name: Build ${{ matrix.target }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            asset_name: metal-analyzer-x86_64-apple-darwin.tar.gz
          - target: aarch64-apple-darwin
            asset_name: metal-analyzer-aarch64-apple-darwin.tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo outputs
        uses: Swatinem/rust-cache@v2

      - name: Build metal-analyzer
        run: cargo build --release -p metal-analyzer --target "${{ matrix.target }}"

      - name: Package binary
        run: |
          mkdir -p dist
          cp "target/${{ matrix.target }}/release/metal-analyzer" "dist/metal-analyzer"
          tar -C dist -czf "${{ matrix.asset_name }}" metal-analyzer

      - name: Upload packaged binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: ${{ matrix.asset_name }}

  release:
    name: Publish GitHub release assets
    runs-on: ubuntu-latest
    needs: build-binaries
    steps:
      - name: Download packaged binaries
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten downloaded artifacts
        run: |
          mkdir -p release
          cp dist/*/*.tar.gz release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum ./*.tar.gz > SHA256SUMS

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign checksums
        run: |
          cd release
          cosign sign-blob --yes --output-signature SHA256SUMS.sig --output-certificate SHA256SUMS.pem SHA256SUMS

      - name: Attach assets to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          overwrite_files: true
          files: |
            release/*.tar.gz
            release/SHA256SUMS
            release/SHA256SUMS.sig
            release/SHA256SUMS.pem
          generate_release_notes: true

  publish-vscode-extension:
    name: Publish VS Code extension
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install extension dependencies
        working-directory: editors/vscode
        run: bun install --frozen-lockfile

      - name: Compile extension
        working-directory: editors/vscode
        run: bun run compile

      - name: Verify release tag matches extension version
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          EXT_VERSION="$(bun -e "console.log(require('./editors/vscode/package.json').version)")"
          TAG_VERSION="${RELEASE_TAG#v}"
          if [ "${EXT_VERSION}" != "${TAG_VERSION}" ]; then
            echo "Release tag (${RELEASE_TAG}) does not match editors/vscode/package.json version (${EXT_VERSION})."
            exit 1
          fi

      - name: Publish stable extension
        if: ${{ !github.event.release.prerelease }}
        working-directory: editors/vscode
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: bun x @vscode/vsce publish --pat "${VSCE_PAT}"

      - name: Publish pre-release extension
        if: ${{ github.event.release.prerelease }}
        working-directory: editors/vscode
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: bun x @vscode/vsce publish --pre-release --pat "${VSCE_PAT}"

  publish-openvsx-extension:
    name: Publish OpenVSX extension
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install extension dependencies
        working-directory: editors/vscode
        run: bun install --frozen-lockfile

      - name: Compile extension
        working-directory: editors/vscode
        run: bun run compile

      - name: Verify release tag matches extension version
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          EXT_VERSION="$(bun -e "console.log(require('./editors/vscode/package.json').version)")"
          TAG_VERSION="${RELEASE_TAG#v}"
          if [ "${EXT_VERSION}" != "${TAG_VERSION}" ]; then
            echo "Release tag (${RELEASE_TAG}) does not match editors/vscode/package.json version (${EXT_VERSION})."
            exit 1
          fi

      - name: Publish stable extension to OpenVSX
        if: ${{ !github.event.release.prerelease }}
        working-directory: editors/vscode
        env:
          OPENVSX_TOKEN: ${{ secrets.OPENVSX_TOKEN }}
        run: bun x ovsx publish -p "${OPENVSX_TOKEN}"

      - name: Publish pre-release extension to OpenVSX
        if: ${{ github.event.release.prerelease }}
        working-directory: editors/vscode
        env:
          OPENVSX_TOKEN: ${{ secrets.OPENVSX_TOKEN }}
        run: bun x ovsx publish --pre-release -p "${OPENVSX_TOKEN}"
