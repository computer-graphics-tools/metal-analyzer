name: Release metal-analyzer

on:
  release:
    types:
      - published

permissions:
  contents: write
  id-token: write

jobs:
  verify-release-versions:
    name: Verify release version alignment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify release tag matches workspace/editor versions
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          python3 <<'PY'
          import json
          import os
          import sys
          from pathlib import Path

          root = Path(".")
          expected_version = os.environ["RELEASE_TAG"]
          if expected_version.startswith("v"):
            expected_version = expected_version[1:]

          def parse_workspace_version(cargo_toml_path: Path) -> str:
            in_workspace_package = False
            for line in cargo_toml_path.read_text().splitlines():
              stripped = line.strip()
              if stripped.startswith("[") and stripped.endswith("]"):
                in_workspace_package = stripped == "[workspace.package]"
                continue
              if in_workspace_package and stripped.startswith("version"):
                _, value = stripped.split("=", 1)
                return value.strip().strip('"')
            raise RuntimeError("Could not read [workspace.package].version from Cargo.toml")

          def parse_zed_extension_version(extension_toml_path: Path) -> str:
            for line in extension_toml_path.read_text().splitlines():
              stripped = line.strip()
              if stripped.startswith("["):
                break
              if stripped.startswith("version"):
                _, value = stripped.split("=", 1)
                return value.strip().strip('"')
            raise RuntimeError("Could not read top-level version from editors/zed/extension.toml")

          workspace_version = parse_workspace_version(root / "Cargo.toml")
          vscode_version = json.loads((root / "editors/code/package.json").read_text())["version"]
          zed_version = parse_zed_extension_version(root / "editors/zed/extension.toml")

          gradle_props = {}
          for line in (root / "editors/intellij/gradle.properties").read_text().splitlines():
            stripped = line.strip()
            if not stripped or stripped.startswith("#") or "=" not in stripped:
              continue
            key, value = stripped.split("=", 1)
            gradle_props[key.strip()] = value.strip()

          intellij_version = gradle_props.get("pluginVersion")
          if intellij_version is None:
            print("editors/intellij/gradle.properties does not define pluginVersion")
            sys.exit(1)

          versions = {
            "Cargo.toml [workspace.package.version]": workspace_version,
            "editors/code/package.json [version]": vscode_version,
            "editors/zed/extension.toml [version]": zed_version,
            "editors/intellij/gradle.properties [pluginVersion]": intellij_version,
          }

          mismatches = {name: version for name, version in versions.items() if version != expected_version}
          if mismatches:
            print(f"Release tag expects version {expected_version}, but found mismatches:")
            for name, version in mismatches.items():
              print(f"  - {name}: {version}")
            sys.exit(1)

          print(f"Release tag {os.environ['RELEASE_TAG']} matches all distribution versions ({expected_version})")
          PY

  build-binaries:
    name: Build ${{ matrix.target }}
    runs-on: macos-latest
    needs: verify-release-versions
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-apple-darwin
            asset_name: metal-analyzer-x86_64-apple-darwin.tar.gz
          - target: aarch64-apple-darwin
            asset_name: metal-analyzer-aarch64-apple-darwin.tar.gz

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust target
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo outputs
        uses: Swatinem/rust-cache@v2

      - name: Build metal-analyzer
        run: cargo build --release -p metal-analyzer --target "${{ matrix.target }}"

      - name: Package binary
        run: |
          mkdir -p dist
          cp "target/${{ matrix.target }}/release/metal-analyzer" "dist/metal-analyzer"
          tar -C dist -czf "${{ matrix.asset_name }}" metal-analyzer

      - name: Upload packaged binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: ${{ matrix.asset_name }}

  release:
    name: Publish GitHub release assets
    runs-on: ubuntu-latest
    needs: build-binaries
    steps:
      - name: Download packaged binaries
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten downloaded artifacts
        run: |
          mkdir -p release
          cp dist/*/*.tar.gz release/

      - name: Generate checksums
        run: |
          cd release
          sha256sum ./*.tar.gz > SHA256SUMS

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign checksums
        run: |
          cd release
          cosign sign-blob --yes --output-signature SHA256SUMS.sig --output-certificate SHA256SUMS.pem SHA256SUMS

      - name: Attach assets to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          overwrite_files: true
          files: |
            release/*.tar.gz
            release/SHA256SUMS
            release/SHA256SUMS.sig
            release/SHA256SUMS.pem
          generate_release_notes: true

  publish-vscode-extension:
    name: Publish VS Code extension
    runs-on: ubuntu-latest
    needs: verify-release-versions
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install extension dependencies
        working-directory: editors/code
        run: bun install --frozen-lockfile

      - name: Compile extension
        working-directory: editors/code
        run: bun run compile

      - name: Verify release tag matches extension version
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          EXT_VERSION="$(bun -e "console.log(require('./editors/code/package.json').version)")"
          TAG_VERSION="${RELEASE_TAG#v}"
          if [ "${EXT_VERSION}" != "${TAG_VERSION}" ]; then
            echo "Release tag (${RELEASE_TAG}) does not match editors/code/package.json version (${EXT_VERSION})."
            exit 1
          fi

      - name: Publish stable extension
        if: ${{ !github.event.release.prerelease }}
        working-directory: editors/code
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: bun x @vscode/vsce publish --pat "${VSCE_PAT}"

      - name: Publish pre-release extension
        if: ${{ github.event.release.prerelease }}
        working-directory: editors/code
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: bun x @vscode/vsce publish --pre-release --pat "${VSCE_PAT}"

  publish-openvsx-extension:
    name: Publish OpenVSX extension
    runs-on: ubuntu-latest
    needs: verify-release-versions
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install extension dependencies
        working-directory: editors/code
        run: bun install --frozen-lockfile

      - name: Compile extension
        working-directory: editors/code
        run: bun run compile

      - name: Verify release tag matches extension version
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          EXT_VERSION="$(bun -e "console.log(require('./editors/code/package.json').version)")"
          TAG_VERSION="${RELEASE_TAG#v}"
          if [ "${EXT_VERSION}" != "${TAG_VERSION}" ]; then
            echo "Release tag (${RELEASE_TAG}) does not match editors/code/package.json version (${EXT_VERSION})."
            exit 1
          fi

      - name: Publish stable extension to OpenVSX
        if: ${{ !github.event.release.prerelease }}
        working-directory: editors/code
        env:
          OPENVSX_TOKEN: ${{ secrets.OPENVSX_TOKEN }}
        run: bun x ovsx publish -p "${OPENVSX_TOKEN}"

      - name: Publish pre-release extension to OpenVSX
        if: ${{ github.event.release.prerelease }}
        working-directory: editors/code
        env:
          OPENVSX_TOKEN: ${{ secrets.OPENVSX_TOKEN }}
        run: bun x ovsx publish --pre-release -p "${OPENVSX_TOKEN}"

  publish-intellij-plugin:
    name: Publish IntelliJ Plugin
    runs-on: ubuntu-latest
    needs: verify-release-versions
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Verify release tag matches plugin version
        env:
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          PLUGIN_VERSION="$(grep '^pluginVersion' editors/intellij/gradle.properties | cut -d= -f2 | tr -d ' ')"
          TAG_VERSION="${RELEASE_TAG#v}"
          if [ "${PLUGIN_VERSION}" != "${TAG_VERSION}" ]; then
            echo "Release tag (${RELEASE_TAG}) does not match editors/intellij/gradle.properties version (${PLUGIN_VERSION})."
            exit 1
          fi

      - name: Publish plugin to JetBrains Marketplace
        working-directory: editors/intellij
        env:
          PUBLISH_TOKEN: ${{ secrets.JETBRAINS_MARKETPLACE_TOKEN }}
        run: ./gradlew publishPlugin
